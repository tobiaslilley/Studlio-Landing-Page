<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Metrics - STUDL.IO</title>
    <meta name="description" content="Explore health metrics and normal ranges by age and gender in STUDL.IO">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="Assets/Website-Favicon-Color.svg">
    
    <!-- Preload fonts for better performance -->
    <link rel="preload" href="Assets/Sanger.ttf" as="font" type="font/ttf" crossorigin>
    <link rel="preload" href="Assets/Cartograph-Sans-Light.ttf" as="font" type="font/ttf" crossorigin>
    
    <!-- CSS -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Chart.js for interactive graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="index.html">
                    <img src="Assets/Title-Only-Transparent.png" alt="STUDL.IO" class="nav-logo-img">
                </a>
            </div>
            <div class="nav-links">
                <a href="index.html#features">Features</a>
                <a href="index.html#download">Download</a>
                <a href="index.html#contact">Contact</a>
                <a href="protocols.html">Protocols</a>
                <a href="health-metrics.html" class="active">Health Metrics</a>
            </div>
        </div>
    </nav>

    <!-- Development Status Banner -->
    <div class="dev-banner">
        <div class="container">
            <p>üöß <strong>Coming Soon!</strong> STUDL.IO is currently in development and will be available soon. Stay tuned for updates!</p>
        </div>
    </div>

    <!-- Health Metrics Section -->
    <section class="health-metrics">
        <div class="container">
            <div class="health-metrics-header">
                <h1 class="section-title">Health Metrics & Normal Ranges</h1>
                <p class="health-metrics-subtitle">Explore normal ranges for various health metrics based on age and gender. Use these reference values to understand where your health data falls within population norms.</p>
                
                <!-- Search and Filter Bar -->
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <input 
                            type="text" 
                            id="searchInput" 
                            class="search-input" 
                            placeholder="Search health metrics by name..."
                            autocomplete="off"
                        >
                        <div class="search-icon">üîç</div>
                    </div>
                    
                    <!-- Gender Filter -->
                    <div class="filter-container">
                        <select id="genderFilter" class="category-dropdown">
                            <option value="">All Genders</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="all">All</option>
                        </select>
                    </div>
                    
                    <div id="searchResults" class="search-results-info"></div>
                </div>
            </div>
            
            <!-- Loading State -->
            <div id="loading" class="loading-state">
                <div class="loading-spinner"></div>
                <p>Loading health metrics...</p>
            </div>
            
            <!-- Error State -->
            <div id="error" class="error-state" style="display: none;">
                <div class="error-icon">‚ö†Ô∏è</div>
                <h3>Unable to load health metrics</h3>
                <p>There was an error connecting to our database. Please try again later.</p>
                <button onclick="loadHealthMetrics()" class="btn btn-primary">Try Again</button>
            </div>
            
            <!-- Health Metrics Grid -->
            <div id="metrics-grid" class="metrics-grid" style="display: none;">
                <!-- Health metrics will be dynamically inserted here -->
            </div>
            
            <!-- Empty State -->
            <div id="empty-state" class="empty-state" style="display: none;">
                <div class="empty-icon">üìä</div>
                <h3>No health metrics available</h3>
                <p>Check back soon for health metric data!</p>
            </div>
            
            <!-- No Search Results State -->
            <div id="no-search-results" class="no-search-results" style="display: none;">
                <div class="empty-icon">üîç</div>
                <h3>No metrics found</h3>
                <p>Try adjusting your search terms or browse all metrics.</p>
                <button onclick="clearSearch()" class="btn btn-secondary">Clear Search</button>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <img src="Assets/Title-Only-Transparent.png" alt="STUDL.IO" class="footer-logo-img">
                </div>
                <div class="footer-links">
                    <a href="index.html#features">Features</a>
                    <a href="index.html#download">Download</a>
                    <a href="index.html#contact">Contact</a>
                    <a href="protocols.html">Protocols</a>
                    <a href="health-metrics.html">Health Metrics</a>
                    <a href="privacy-policy.html">Privacy Policy</a>
                    <a href="https://x.com/studl_io" target="_blank" rel="noopener noreferrer">Follow on X</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 STUDL.IO. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://htizxlmrzfehvpupvwbn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0aXp4bG1yemZlaHZwdXB2d2JuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMTY3NDEsImV4cCI6MjA3MTY5Mjc0MX0.pBC8d5zXG6DZeU3atMZEqOgY4WG8Mh7T0m2tVk5CcUY';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Global variables for search functionality
        let allMetrics = [];
        let allNormsData = {};
        
        // Test Supabase connection
        async function testSupabaseConnection() {
            try {
                console.log('Testing Supabase connection...');
                const { data, error } = await supabase
                    .from('health_metrics')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    console.error('Supabase connection test failed:', error);
                    return false;
                }
                
                console.log('Supabase connection test successful');
                return true;
            } catch (error) {
                console.error('Supabase connection test error:', error);
                return false;
            }
        }
        
        // Load health metrics from Supabase
        async function loadHealthMetrics() {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const metricsGridEl = document.getElementById('metrics-grid');
            const emptyStateEl = document.getElementById('empty-state');
            
            try {
                // Show loading state
                loadingEl.style.display = 'block';
                errorEl.style.display = 'none';
                metricsGridEl.style.display = 'none';
                emptyStateEl.style.display = 'none';
                
                // Test connection first
                const connectionOk = await testSupabaseConnection();
                if (!connectionOk) {
                    throw new Error('Failed to connect to Supabase database');
                }
                
                // Fetch health metrics with norms data
                const { data: metrics, error: metricsError } = await supabase
                    .from('health_metrics')
                    .select(`
                        *,
                        health_metric_norms (
                            sex,
                            age_years_min,
                            age_years_max,
                            mean_value,
                            sd_value,
                            p10,
                            p25,
                            p50,
                            p75,
                            p90,
                            method,
                            source_name,
                            source_url,
                            notes
                        )
                    `)
                    .order('name');
                
                if (metricsError) {
                    throw metricsError;
                }
                
                // Filter metrics that have norms data
                const metricsWithNorms = (metrics || []).filter(metric => 
                    metric.health_metric_norms && metric.health_metric_norms.length > 0
                );
                
                // Store data globally for search functionality
                allMetrics = metricsWithNorms;
                allNormsData = {};
                
                // Process norms data for easier access
                metricsWithNorms.forEach(metric => {
                    allNormsData[metric.id] = metric.health_metric_norms;
                });
                
                // Hide loading state
                loadingEl.style.display = 'none';
                
                if (metricsWithNorms.length === 0) {
                    // Show empty state
                    emptyStateEl.style.display = 'block';
                } else {
                    // Display metrics with charts
                    displayMetrics(metricsWithNorms);
                    metricsGridEl.style.display = 'grid';
                    updateSearchResults(metricsWithNorms.length, metricsWithNorms.length);
                }
                
            } catch (error) {
                console.error('Error loading health metrics:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    details: error.details,
                    hint: error.hint
                });
                
                // Show error state with more details
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                
                // Update error message with more details
                const errorMessage = document.querySelector('#error p');
                if (errorMessage) {
                    errorMessage.innerHTML = `
                        There was an error connecting to our database.<br>
                        <small style="color: #999; margin-top: 0.5rem; display: block;">
                            Error: ${error.message || 'Unknown error'}<br>
                            Code: ${error.code || 'N/A'}
                        </small>
                    `;
                }
            }
        }
        
        // Display metrics in the grid
        function displayMetrics(metrics) {
            const metricsGridEl = document.getElementById('metrics-grid');
            
            metricsGridEl.innerHTML = metrics.map(metric => {
                const norms = metric.health_metric_norms || [];
                const hasData = norms.length > 0;
                
                return `
                <div class="metric-card">
                    <div class="metric-header">
                        <h3 class="metric-title">${escapeHtml(metric.name || 'Untitled Metric')}</h3>
                        <div class="metric-unit">${escapeHtml(metric.unit || '‚Äî')}</div>
                    </div>
                    <div class="metric-content">
                        <p class="metric-description">${escapeHtml(metric.identifier || 'HealthKit metric')}</p>
                        ${hasData ? `
                            <div class="metric-chart-container">
                                <canvas id="chart-${metric.id}" class="metric-chart"></canvas>
                            </div>
                            <div class="metric-stats">
                                <div class="stat-item">
                                    <span class="stat-label">Age Range:</span>
                                    <span class="stat-value">${getAgeRange(norms)}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Genders:</span>
                                    <span class="stat-value">${getAvailableGenders(norms)}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Data Points:</span>
                                    <span class="stat-value">${norms.length}</span>
                                </div>
                            </div>
                            <div class="metric-source">
                                <span class="source-label">Source:</span>
                                <a href="${getSourceUrl(norms)}" target="_blank" rel="noopener noreferrer" class="source-link">
                                    ${getSourceName(norms)}
                                </a>
                            </div>
                            ${getNotes(norms) ? `
                                <div class="metric-notes">
                                    <span class="notes-label">Notes:</span>
                                    <p class="notes-text">${getNotes(norms)}</p>
                                </div>
                            ` : ''}
                        ` : `
                            <div class="no-data-message">
                                <p>No normal range data available for this metric.</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
            }).join('');
            
            // Create charts after DOM is updated
            setTimeout(() => {
                metrics.forEach(metric => {
                    if (metric.health_metric_norms && metric.health_metric_norms.length > 0) {
                        createChart(metric);
                    }
                });
            }, 100);
        }
        
        // Create Chart.js chart for a metric
        function createChart(metric) {
            const canvas = document.getElementById(`chart-${metric.id}`);
            if (!canvas) return;
            
            // Check if Chart.js is available
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not loaded');
                canvas.parentElement.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">Chart library not available</p>';
                return;
            }
            
            const norms = metric.health_metric_norms || [];
            const ctx = canvas.getContext('2d');
            
            // Get current gender filter
            const selectedGender = document.getElementById('genderFilter').value;
            
            // Group data by gender and age
            const dataByGender = {};
            norms.forEach(norm => {
                // Clean up gender value - handle null, undefined, or string "undefined"
                let gender = norm.sex;
                
                
                if (!gender || gender === 'undefined' || gender === 'null') {
                    gender = 'unknown';
                }
                
                // If a gender filter is selected, only include data for that gender
                if (selectedGender && gender !== selectedGender) {
                    return;
                }
                
                if (!dataByGender[gender]) {
                    dataByGender[gender] = [];
                }
                dataByGender[gender].push({
                    age: (norm.age_years_min + norm.age_years_max) / 2,
                    ageRange: `${norm.age_years_min}-${norm.age_years_max}`,
                    p10: parseFloat(norm.p10) || 0,
                    p25: parseFloat(norm.p25) || 0,
                    p50: parseFloat(norm.p50) || 0,
                    p75: parseFloat(norm.p75) || 0,
                    p90: parseFloat(norm.p90) || 0,
                    mean: parseFloat(norm.mean_value) || 0
                });
            });
            
            // Sort by age
            Object.keys(dataByGender).forEach(gender => {
                dataByGender[gender].sort((a, b) => a.age - b.age);
            });
            
            
            // Prepare chart data
            const datasets = [];
            const colors = {
                'male': '#3B82F6',
                'female': '#EC4899',
                'all': '#10B981',
                'unknown': '#6B7280'
            };
            
            Object.keys(dataByGender).forEach(gender => {
                const data = dataByGender[gender];
                
                // Skip if no data or if gender is still undefined/null
                if (!data || data.length === 0 || !gender || gender === 'undefined' || gender === 'null') {
                    return;
                }
                
                const color = colors[gender] || colors['unknown'];
                
                // Clean up gender label to avoid "Undefined"
                const genderLabel = (gender === 'unknown' || !gender) ? 'Unknown' : 
                                   gender.charAt(0).toUpperCase() + gender.slice(1);
                
                // Add median line (p50)
                datasets.push({
                    label: `${genderLabel} (Median)`,
                    data: data.map(d => ({ x: d.age, y: d.p50 })),
                    borderColor: color,
                    backgroundColor: color + '20',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1
                });
                
                // Add percentile ranges (p25-p75)
                datasets.push({
                    label: `${genderLabel} (25th-75th percentile)`,
                    data: data.map(d => ({ x: d.age, y: d.p75 })),
                    borderColor: color + '80',
                    backgroundColor: color + '10',
                    borderWidth: 1,
                    fill: '+1',
                    tension: 0.1
                });
                
                datasets.push({
                    label: `${genderLabel} (25th percentile)`,
                    data: data.map(d => ({ x: d.age, y: d.p25 })),
                    borderColor: color + '80',
                    backgroundColor: color + '10',
                    borderWidth: 1,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0
                });
            });
            
            new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(context) {
                                    return `Age: ${context[0].parsed.x.toFixed(0)} years`;
                                },
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    return `${label}: ${value.toFixed(1)} ${metric.unit || ''}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Age (years)',
                                font: {
                                    size: 12
                                }
                            },
                            ticks: {
                                stepSize: 10
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: metric.unit || 'Value',
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }
        
        // Helper function to get age range
        function getAgeRange(norms) {
            if (!norms || norms.length === 0) return 'N/A';
            const ages = norms.flatMap(n => [n.age_years_min, n.age_years_max]);
            const minAge = Math.min(...ages);
            const maxAge = Math.max(...ages);
            return `${minAge}-${maxAge} years`;
        }
        
        // Helper function to get available genders
        function getAvailableGenders(norms) {
            if (!norms || norms.length === 0) return 'N/A';
            const genders = [...new Set(norms.map(n => n.sex).filter(Boolean))];
            return genders.map(g => g.charAt(0).toUpperCase() + g.slice(1)).join(', ');
        }
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Helper function to get source name
        function getSourceName(norms) {
            if (!norms || norms.length === 0) return 'N/A';
            
            // Find the first norm with a source_name
            const normWithSource = norms.find(norm => norm.source_name && norm.source_name.trim() !== '');
            if (normWithSource) {
                return escapeHtml(normWithSource.source_name);
            }
            
            return 'Unknown Source';
        }
        
        // Helper function to get source URL
        function getSourceUrl(norms) {
            if (!norms || norms.length === 0) return '#';
            
            // Find the first norm with a source_url
            const normWithSource = norms.find(norm => norm.source_url && norm.source_url.trim() !== '');
            if (normWithSource) {
                return escapeHtml(normWithSource.source_url);
            }
            
            return '#';
        }
        
        // Helper function to get notes
        function getNotes(norms) {
            if (!norms || norms.length === 0) return null;
            
            // Find the first norm with notes
            const normWithNotes = norms.find(norm => norm.notes && norm.notes.trim() !== '');
            if (normWithNotes) {
                return escapeHtml(normWithNotes.notes.trim());
            }
            
            return null;
        }
        
        // Combined search and filter functionality
        function filterMetrics() {
            const searchTerm = document.getElementById('searchInput').value;
            const selectedGender = document.getElementById('genderFilter').value;
            
            let filteredMetrics = allMetrics;
            
            // Apply gender filter
            if (selectedGender) {
                filteredMetrics = filteredMetrics.filter(metric => {
                    const norms = allNormsData[metric.id] || [];
                    return norms.some(norm => norm.sex === selectedGender);
                });
            }
            
            // Apply search filter
            if (searchTerm && searchTerm.trim() !== '') {
                const searchLower = searchTerm.toLowerCase();
                filteredMetrics = filteredMetrics.filter(metric => {
                    // Search in metric name
                    if (metric.name && metric.name.toLowerCase().includes(searchLower)) {
                        return true;
                    }
                    
                    // Search in identifier
                    if (metric.identifier && metric.identifier.toLowerCase().includes(searchLower)) {
                        return true;
                    }
                    
                    return false;
                });
            }
            
            // Update display
            if (filteredMetrics.length === 0) {
                document.getElementById('metrics-grid').style.display = 'none';
                document.getElementById('no-search-results').style.display = 'block';
            } else {
                displayMetrics(filteredMetrics);
                document.getElementById('metrics-grid').style.display = 'grid';
                document.getElementById('no-search-results').style.display = 'none';
            }
            
            updateSearchResults(filteredMetrics.length, allMetrics.length);
        }
        
        // Update search results counter
        function updateSearchResults(shown, total) {
            const searchResultsEl = document.getElementById('searchResults');
            if (shown === total) {
                searchResultsEl.textContent = '';
            } else {
                searchResultsEl.textContent = `Showing ${shown} of ${total} metrics`;
            }
        }
        
        // Clear search and filters
        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            const genderFilter = document.getElementById('genderFilter');
            searchInput.value = '';
            genderFilter.value = '';
            filterMetrics();
        }
        
        // Load metrics when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadHealthMetrics();
            
            // Add search event listener
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', () => {
                filterMetrics();
            });
            
            // Add gender filter event listener
            const genderFilter = document.getElementById('genderFilter');
            genderFilter.addEventListener('change', () => {
                filterMetrics();
            });
        });
    </script>
</body>
</html>
