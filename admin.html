<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STUDL.IO Admin - Dashboard</title>
    <meta name="description" content="STUDL.IO Admin Dashboard - Manage your biohacking protocols and health data.">
    
    <!-- OpenGraph Meta Tags -->
    <meta property="og:title" content="Admin Dashboard - STUDL.IO">
    <meta property="og:description" content="STUDL.IO Admin Dashboard - Manage your biohacking protocols and health data.">
    <meta property="og:image" content="https://studl.io/Assets/opengraph.png">
    <meta property="og:url" content="https://studl.io/admin.html">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="STUDL.IO">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Admin Dashboard - STUDL.IO">
    <meta name="twitter:description" content="STUDL.IO Admin Dashboard - Manage your biohacking protocols and health data.">
    <meta name="twitter:image" content="Assets/opengraph.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="Assets/Website-Favicon-Color.svg">
    
    <!-- Preload fonts for better performance -->
    <link rel="preload" href="Assets/Sanger.ttf" as="font" type="font/ttf" crossorigin>
    <link rel="preload" href="Assets/Cartograph-Sans-Light.ttf" as="font" type="font/ttf" crossorigin>
    
    <!-- CSS -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Vercel Analytics -->
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="https://cdn.vercel-insights.com/v1/script.debug.js"></script>
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="index.html">
                    <img src="Assets/Title-Only-Transparent.png" alt="STUDL.IO" class="nav-logo-img">
                </a>
            </div>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="protocols.html">Protocols</a>
                <a href="#" id="adminLink" style="display: none;">Admin</a>
                <a href="#" id="signOutLink" style="display: none;">Sign Out</a>
            </div>
        </div>
    </nav>

    <!-- Development Status Banner -->
    <div class="dev-banner">
        <div class="container">
            <p>üöß <strong>Coming Soon!</strong> STUDL.IO is currently in development and will be available soon. Stay tuned for updates!</p>
        </div>
    </div>
    <!-- Authentication Section (shown when not logged in) -->
    <section id="authSection" class="auth-section">
        <div class="container">
            <div class="auth-container">
                <div class="auth-card">
                    <div class="auth-header">
                        <img src="Assets/Logo-Only-Transparent.png" alt="STUDL.IO" class="auth-logo">
                        <h1 class="auth-title">Admin Access</h1>
                        <p class="auth-subtitle">Sign in to access the STUDL.IO admin dashboard</p>
                    </div>
                    
                    <div class="auth-form">
                        <div id="authError" class="auth-error" style="display: none;"></div>
                        
                        <!-- Magic Link Form -->
                        <form id="magicLinkForm" class="auth-form-content">
                            <div class="form-group">
                                <label for="email">Email Address</label>
                                <input type="email" id="email" name="email" required placeholder="Enter your email" value="tobylilley@gmail.com">
                            </div>
                            
                            <button type="submit" class="btn btn-primary btn-full" id="magicLinkBtn">
                                <span class="btn-text">Send Magic Link</span>
                                <span class="btn-loading" style="display: none;">Sending...</span>
                            </button>
                        </form>
                        
                        <div class="auth-info">
                            <p>We'll send you a secure link to sign in instantly - no password required!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Admin Dashboard (shown when logged in) -->
    <section id="adminDashboard" class="admin-dashboard" style="display: none;">
        <div class="container">
            <div class="admin-header">
                <h1 class="admin-title">Admin Dashboard</h1>
                <p class="admin-subtitle">Welcome back! Manage your STUDL.IO content and settings.</p>
            </div>
            
            <div class="admin-grid">
                <!-- User Info Card -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3>User Information</h3>
                    </div>
                    <div class="admin-card-content">
                        <div class="user-info">
                            <p><strong>Email:</strong> <span id="userEmail"></span></p>
                            <p><strong>Last Sign In:</strong> <span id="lastSignIn"></span></p>
                            <p><strong>Account Created:</strong> <span id="accountCreated"></span></p>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions Card -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3>Quick Actions</h3>
                    </div>
                    <div class="admin-card-content">
                        <div class="quick-actions">
                            <button class="btn btn-secondary btn-small" onclick="window.open('protocols.html', '_blank')">
                                View Protocols
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="window.open('index.html', '_blank')">
                                View Main Site
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- System Status Card -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3>System Status</h3>
                    </div>
                    <div class="admin-card-content">
                        <div class="status-item">
                            <span class="status-label">Database:</span>
                            <span class="status-value status-healthy">Connected</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Authentication:</span>
                            <span class="status-value status-healthy">Active</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Last Updated:</span>
                            <span class="status-value" id="lastUpdated"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Protocols Management Card -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3>Protocols Management</h3>
                    </div>
                    <div class="admin-card-content">
                        <div class="admin-tools">
                            <button class="btn btn-primary btn-small" onclick="showProtocolsManager()">
                                Manage Protocols
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="addNewProtocol()">
                                Add New Protocol
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Health Metrics Management Card -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3>Health Metrics Management</h3>
                    </div>
                    <div class="admin-card-content">
                        <div class="admin-tools">
                            <button class="btn btn-primary btn-small" onclick="showMetricsManager()">
                                Manage Health Metrics
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="addNewMetric()">
                                Add New Metric
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Admin Tools Card -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3>Admin Tools</h3>
                    </div>
                    <div class="admin-card-content">
                        <div class="admin-tools">
                            <button class="btn btn-primary btn-small" onclick="refreshData()">
                                Refresh Data
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="exportData()">
                                Export Data
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="viewLogs()">
                                View Logs
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Protocols Management Section -->
    <section id="protocolsManager" class="admin-manager" style="display: none;">
        <div class="container">
            <div class="manager-header">
                <h2>Protocols Management</h2>
                <button class="btn btn-secondary" onclick="hideProtocolsManager()">‚Üê Back to Dashboard</button>
            </div>
            
            <div class="manager-actions">
                <button class="btn btn-primary" onclick="addNewProtocol()">Add New Protocol</button>
                <div class="search-container">
                    <input type="text" id="protocolSearch" placeholder="Search protocols..." class="search-input">
                </div>
            </div>
            
            <div id="protocolsList" class="manager-list">
                <!-- Protocols will be loaded here -->
            </div>
        </div>
    </section>

    <!-- Health Metrics Management Section -->
    <section id="metricsManager" class="admin-manager" style="display: none;">
        <div class="container">
            <div class="manager-header">
                <h2>Health Metrics Management</h2>
                <button class="btn btn-secondary" onclick="hideMetricsManager()">‚Üê Back to Dashboard</button>
            </div>
            
            <div class="manager-actions">
                <button class="btn btn-primary" onclick="addNewMetric()">Add New Metric</button>
                <div class="search-container">
                    <input type="text" id="metricSearch" placeholder="Search metrics..." class="search-input">
                </div>
            </div>
            
            <div id="metricsList" class="manager-list">
                <!-- Metrics will be loaded here -->
            </div>
        </div>
    </section>

    <!-- Protocol Form Modal -->
    <div id="protocolModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="protocolModalTitle">Add New Protocol</h3>
                <button class="modal-close" onclick="closeProtocolModal()">&times;</button>
            </div>
            <form id="protocolForm" class="modal-form">
                <input type="hidden" id="protocolId" name="id">
                
                <div class="form-group">
                    <label for="protocolName">Name *</label>
                    <input type="text" id="protocolName" name="name" required>
                </div>
                
                <div class="form-group">
                    <label for="protocolCategory">Category *</label>
                    <select id="protocolCategory" name="category" required>
                        <option value="">Select Category</option>
                        <option value="Diet">Diet</option>
                        <option value="Exercise">Exercise</option>
                        <option value="Sleep">Sleep</option>
                        <option value="Supplement">Supplement</option>
                        <option value="Environment">Environment</option>
                        <option value="Mental Health">Mental Health</option>
                        <option value="General">General</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="protocolDescription">Description</label>
                    <textarea id="protocolDescription" name="description" rows="4"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="protocolUnit">Unit</label>
                    <input type="text" id="protocolUnit" name="unit" placeholder="e.g., mg, days, hours">
                </div>
                
                <div class="form-group">
                    <label for="protocolDefaultValue">Default Value</label>
                    <input type="number" id="protocolDefaultValue" name="default_value" step="0.01">
                </div>
                
                <div class="form-group">
                    <label for="protocolMetricIds">Related Health Metrics</label>
                    <select id="protocolMetricIds" name="metric_ids" multiple>
                        <!-- Options will be populated dynamically -->
                    </select>
                    <small>Hold Ctrl/Cmd to select multiple metrics</small>
                </div>
                
                <div class="form-group">
                    <label>Citations</label>
                    <div id="citationsContainer">
                        <!-- Citations will be dynamically added here -->
                    </div>
                    <button type="button" class="btn btn-secondary btn-small" onclick="addCitationField()" style="margin-top: 10px;">
                        + Add Citation
                    </button>
                    <small>Add scientific references and sources for this protocol. Each citation should be a complete reference.</small>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="protocolIsDefault" name="is_default">
                        Set as default protocol
                    </label>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeProtocolModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Protocol</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Health Metric Form Modal -->
    <div id="metricModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="metricModalTitle">Add New Health Metric</h3>
                <button class="modal-close" onclick="closeMetricModal()">&times;</button>
            </div>
            <form id="metricForm" class="modal-form">
                <input type="hidden" id="metricId" name="id">
                
                <div class="form-group">
                    <label for="metricName">Name *</label>
                    <input type="text" id="metricName" name="name" required>
                </div>
                
                <div class="form-group">
                    <label for="metricIdentifier">HealthKit Identifier *</label>
                    <input type="text" id="metricIdentifier" name="identifier" required placeholder="e.g., HKQuantityTypeIdentifierStepCount">
                </div>
                
                <div class="form-group">
                    <label for="metricUnit">Unit *</label>
                    <input type="text" id="metricUnit" name="unit" required placeholder="e.g., count, kcal, mg/dL">
                </div>
                
                <div class="form-group">
                    <label for="metricKind">Kind</label>
                    <select id="metricKind" name="kind">
                        <option value="quantity">Quantity</option>
                        <option value="category">Category</option>
                        <option value="correlation">Correlation</option>
                        <option value="workout">Workout</option>
                        <option value="series">Series</option>
                        <option value="electrocardiogram">Electrocardiogram</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="metricPreferredStats">Preferred Stats</label>
                    <select id="metricPreferredStats" name="preferred_stats" multiple>
                        <option value="sum">Sum</option>
                        <option value="avg">Average</option>
                        <option value="min">Minimum</option>
                        <option value="max">Maximum</option>
                        <option value="most_recent">Most Recent</option>
                        <option value="duration_sum">Duration Sum</option>
                        <option value="count">Count</option>
                        <option value="distance_sum">Distance Sum</option>
                        <option value="energy_sum">Energy Sum</option>
                    </select>
                    <small>Hold Ctrl/Cmd to select multiple stats</small>
                </div>
                
                <div class="form-group">
                    <label for="metricUnitInternal">Internal Unit</label>
                    <input type="text" id="metricUnitInternal" name="unit_internal" placeholder="Internal unit for calculations">
                </div>
                
                <div class="form-group">
                    <label for="metricUnitDisplayStrategy">Unit Display Strategy</label>
                    <select id="metricUnitDisplayStrategy" name="unit_display_strategy">
                        <option value="by_locale">By Locale</option>
                        <option value="fixed">Fixed</option>
                        <option value="from_device">From Device</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="metricCategories">Health Categories</label>
                    <select id="metricCategories" name="categories" multiple>
                        <!-- Options will be populated dynamically -->
                    </select>
                    <small>Hold Ctrl/Cmd to select multiple categories</small>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeMetricModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Metric</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <img src="Assets/Title-Only-Transparent.png" alt="STUDL.IO" class="footer-logo-img">
                </div>
                <div class="footer-links">
                    <a href="index.html#features">Features</a>
                    <a href="index.html#download">Download</a>
                    <a href="index.html#contact">Contact</a>
                    <a href="protocols.html">Protocols</a>
                    <a href="admin.html">Admin</a>
                    <a href="privacy-policy.html">Privacy Policy</a>
                    <a href="terms-of-service.html">Terms of Service</a>
                    <a href="https://x.com/studl_io" target="_blank" rel="noopener noreferrer">Follow on X</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 STUDL.IO. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://htizxlmrzfehvpupvwbn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0aXp4bG1yemZlaHZwdXB2d2JuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMTY3NDEsImV4cCI6MjA3MTY5Mjc0MX0.pBC8d5zXG6DZeU3atMZEqOgY4WG8Mh7T0m2tVk5CcUY';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // DOM elements
        const authSection = document.getElementById('authSection');
        const adminDashboard = document.getElementById('adminDashboard');
        const magicLinkForm = document.getElementById('magicLinkForm');
        const authError = document.getElementById('authError');
        const adminLink = document.getElementById('adminLink');
        const signOutLink = document.getElementById('signOutLink');
        
        // Check authentication status on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuthStatus();
        });
        
        // Check if user is authenticated
        async function checkAuthStatus() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (session) {
                    showAdminDashboard(session.user);
                } else {
                    showAuthSection();
                }
            } catch (error) {
                console.error('Error checking auth status:', error);
                showAuthSection();
            }
        }
        
        // Show authentication section
        function showAuthSection() {
            authSection.style.display = 'block';
            adminDashboard.style.display = 'none';
            adminLink.style.display = 'none';
            signOutLink.style.display = 'none';
        }
        
        // Show admin dashboard
        function showAdminDashboard(user) {
            authSection.style.display = 'none';
            adminDashboard.style.display = 'block';
            adminLink.style.display = 'inline';
            signOutLink.style.display = 'inline';
            
            // Update user info
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('lastSignIn').textContent = new Date(user.last_sign_in_at).toLocaleString();
            document.getElementById('accountCreated').textContent = new Date(user.created_at).toLocaleString();
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
        }
        
        // Magic link form submission
        magicLinkForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const magicLinkBtn = document.getElementById('magicLinkBtn');
            const btnText = magicLinkBtn.querySelector('.btn-text');
            const btnLoading = magicLinkBtn.querySelector('.btn-loading');
            
            // Show loading state
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline';
            magicLinkBtn.disabled = true;
            hideError();
            
            try {
                const { error } = await supabase.auth.signInWithOtp({
                    email: email,
                    options: {
                        emailRedirectTo: window.location.origin + '/'
                    }
                });
                
                if (error) {
                    showError(error.message);
                } else {
                    showSuccess('Magic link sent! Check your email and click the link to sign in.');
                }
            } catch (error) {
                showError('An unexpected error occurred. Please try again.');
            } finally {
                // Reset button state
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
                magicLinkBtn.disabled = false;
            }
        });
        
        // Sign out functionality
        signOutLink.addEventListener('click', async (e) => {
            e.preventDefault();
            
            try {
                await supabase.auth.signOut();
                showAuthSection();
            } catch (error) {
                console.error('Error signing out:', error);
            }
        });
        
        
        // Error handling
        function showError(message) {
            authError.textContent = message;
            authError.style.display = 'block';
        }
        
        function hideError() {
            authError.style.display = 'none';
        }
        
        function showSuccess(message) {
            authError.textContent = message;
            authError.className = 'auth-error auth-success';
            authError.style.display = 'block';
        }
        
        // Admin functions
        function refreshData() {
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
            alert('Data refreshed successfully!');
        }
        
        function exportData() {
            alert('Export functionality coming soon!');
        }
        
        function viewLogs() {
            alert('Log viewer coming soon!');
        }
        
        // Listen for auth state changes
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' && session) {
                showAdminDashboard(session.user);
            } else if (event === 'SIGNED_OUT') {
                showAuthSection();
            }
        });

        // Global variables for CRUD operations
        let allProtocols = [];
        let allHealthMetrics = [];

        // ===== PROTOCOLS MANAGEMENT =====
        
        // Show protocols manager
        function showProtocolsManager() {
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('protocolsManager').style.display = 'block';
            loadProtocolsForManagement();
        }

        // Hide protocols manager
        function hideProtocolsManager() {
            document.getElementById('protocolsManager').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
        }

        // Load protocols for management
        async function loadProtocolsForManagement() {
            try {
                const { data: protocols, error } = await supabase
                    .from('protocols')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allProtocols = protocols || [];
                displayProtocolsForManagement(allProtocols);
            } catch (error) {
                console.error('Error loading protocols:', error);
                alert('Error loading protocols: ' + error.message);
            }
        }

        // Display protocols in management view
        function displayProtocolsForManagement(protocols) {
            const protocolsList = document.getElementById('protocolsList');
            
            if (!protocols || protocols.length === 0) {
                protocolsList.innerHTML = '<p class="no-data">No protocols found.</p>';
                return;
            }

            protocolsList.innerHTML = protocols.map(protocol => `
                <div class="manager-item">
                    <div class="item-content">
                        <h4>${escapeHtml(protocol.name || 'Untitled Protocol')}</h4>
                        <p class="item-meta">
                            <span class="category">${escapeHtml(protocol.category || 'General')}</span>
                            ${protocol.unit && protocol.unit !== '‚Äî' ? `<span class="unit">${escapeHtml(protocol.unit)}</span>` : ''}
                            ${protocol.is_default ? '<span class="badge">Default</span>' : ''}
                            ${protocol.citations && protocol.citations.length > 0 ? `<span class="citations-count">${protocol.citations.length} citation${protocol.citations.length === 1 ? '' : 's'}</span>` : ''}
                        </p>
                        <p class="item-description">${escapeHtml(protocol.description || 'No description')}</p>
                        ${protocol.citations && protocol.citations.length > 0 ? `<div class="citations-preview"><strong>Citations:</strong> ${protocol.citations.slice(0, 2).map(citation => {
                            if (typeof citation === 'string') {
                                return escapeHtml(citation);
                            } else if (citation && citation.title) {
                                return escapeHtml(citation.title);
                            }
                            return '';
                        }).filter(title => title).join('; ')}${protocol.citations.length > 2 ? '...' : ''}</div>` : ''}
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-small btn-secondary" onclick="editProtocol('${protocol.id}')">Edit</button>
                        <button class="btn btn-small btn-danger" onclick="deleteProtocol('${protocol.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Add new protocol
        function addNewProtocol() {
            document.getElementById('protocolModalTitle').textContent = 'Add New Protocol';
            document.getElementById('protocolForm').reset();
            document.getElementById('protocolId').value = '';
            populateHealthMetricsDropdown();
            // Initialize citations with one empty field
            loadCitations([]);
            document.getElementById('protocolModal').style.display = 'block';
        }

        // Edit protocol
        async function editProtocol(protocolId) {
            try {
                const { data: protocol, error } = await supabase
                    .from('protocols')
                    .select('*')
                    .eq('id', protocolId)
                    .single();

                if (error) throw error;

                // Populate form
                document.getElementById('protocolModalTitle').textContent = 'Edit Protocol';
                document.getElementById('protocolId').value = protocol.id;
                document.getElementById('protocolName').value = protocol.name || '';
                document.getElementById('protocolCategory').value = protocol.category || '';
                document.getElementById('protocolDescription').value = protocol.description || '';
                document.getElementById('protocolUnit').value = protocol.unit || '';
                document.getElementById('protocolDefaultValue').value = protocol.default_value || '';
                // Load citations using the new system
                loadCitations(protocol.citations || []);
                document.getElementById('protocolIsDefault').checked = protocol.is_default || false;

                // Populate health metrics dropdown and select current ones
                await populateHealthMetricsDropdown();
                const metricSelect = document.getElementById('protocolMetricIds');
                if (protocol.metric_ids && protocol.metric_ids.length > 0) {
                    Array.from(metricSelect.options).forEach(option => {
                        option.selected = protocol.metric_ids.includes(option.value);
                    });
                }

                document.getElementById('protocolModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading protocol:', error);
                alert('Error loading protocol: ' + error.message);
            }
        }

        // Delete protocol
        async function deleteProtocol(protocolId) {
            if (!confirm('Are you sure you want to delete this protocol? This action cannot be undone.')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('protocols')
                    .delete()
                    .eq('id', protocolId);

                if (error) throw error;

                alert('Protocol deleted successfully!');
                loadProtocolsForManagement();
            } catch (error) {
                console.error('Error deleting protocol:', error);
                alert('Error deleting protocol: ' + error.message);
            }
        }

        // Populate health metrics dropdown
        async function populateHealthMetricsDropdown() {
            try {
                const { data: metrics, error } = await supabase
                    .from('health_metrics')
                    .select('id, name, unit')
                    .order('name');

                if (error) throw error;

                const select = document.getElementById('protocolMetricIds');
                select.innerHTML = '';

                if (metrics && metrics.length > 0) {
                    metrics.forEach(metric => {
                        const option = document.createElement('option');
                        option.value = metric.id;
                        option.textContent = `${metric.name} (${metric.unit || 'no unit'})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading health metrics:', error);
            }
        }

        // Close protocol modal
        function closeProtocolModal() {
            document.getElementById('protocolModal').style.display = 'none';
        }

        // Handle protocol form submission
        document.getElementById('protocolForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            
            // Get citations from the new citation management system
            const citations = getAllCitations();
            console.log('Citations being saved:', citations);
            
            const protocolData = {
                name: formData.get('name'),
                category: formData.get('category'),
                description: formData.get('description'),
                unit: formData.get('unit'),
                default_value: formData.get('default_value') ? parseFloat(formData.get('default_value')) : null,
                citations: citations,
                is_default: formData.get('is_default') === 'on',
                metric_ids: Array.from(document.getElementById('protocolMetricIds').selectedOptions).map(option => option.value)
            };
            
            console.log('Protocol data being sent:', protocolData);

            const protocolId = formData.get('id');

            try {
                if (protocolId) {
                    // Update existing protocol
                    console.log('Updating protocol with ID:', protocolId);
                    console.log('Update data:', protocolData);
                    
                    // First, let's check if the protocol exists
                    const { data: existingProtocol, error: fetchError } = await supabase
                        .from('protocols')
                        .select('id, name, citations')
                        .eq('id', protocolId)
                        .single();
                    
                    console.log('Existing protocol check:', { existingProtocol, fetchError });
                    console.log('Current citations in DB:', existingProtocol.citations);
                    
                    // Try updating just the citations field first
                    const { data: citationUpdate, error: citationError } = await supabase
                        .from('protocols')
                        .update({ citations: protocolData.citations })
                        .eq('id', protocolId)
                        .select();

                    console.log('Citation-only update response:', { citationUpdate, citationError });
                    
                    if (citationError) {
                        console.error('Citation update failed:', citationError);
                        // Fall back to full update
                        const { data, error } = await supabase
                            .from('protocols')
                            .update(protocolData)
                            .eq('id', protocolId)
                            .select();

                        console.log('Full update response:', { data, error });
                        
                        if (error) throw error;
                        
                        if (data && data.length === 0) {
                            console.warn('No rows were updated - protocol might not exist or ID mismatch');
                            alert('Warning: No rows were updated. Please check if the protocol exists.');
                        } else {
                            alert('Protocol updated successfully!');
                        }
                    } else {
                        console.log('Citation update successful!');
                        
                        // Verify the update by fetching the protocol again
                        const { data: verifyProtocol, error: verifyError } = await supabase
                            .from('protocols')
                            .select('id, name, citations')
                            .eq('id', protocolId)
                            .single();
                        
                        console.log('Verification - updated protocol:', verifyProtocol);
                        console.log('New citations in DB:', verifyProtocol.citations);
                        
                        if (verifyProtocol.citations && verifyProtocol.citations.length > 0) {
                            alert('Protocol citations updated successfully!');
                        } else {
                            console.warn('Citations were not actually updated in the database');
                            alert('Warning: Citations may not have been updated. Please check the database.');
                        }
                    }
                } else {
                    // Create new protocol
                    console.log('Creating new protocol with data:', protocolData);
                    
                    const { data, error } = await supabase
                        .from('protocols')
                        .insert(protocolData)
                        .select();

                    console.log('Insert response:', { data, error });
                    
                    if (error) throw error;
                    alert('Protocol created successfully!');
                }

                closeProtocolModal();
                loadProtocolsForManagement();
            } catch (error) {
                console.error('Error saving protocol:', error);
                alert('Error saving protocol: ' + error.message);
            }
        });

        // ===== HEALTH METRICS MANAGEMENT =====

        // Show metrics manager
        function showMetricsManager() {
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('metricsManager').style.display = 'block';
            loadHealthMetricsForManagement();
        }

        // Hide metrics manager
        function hideMetricsManager() {
            document.getElementById('metricsManager').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
        }

        // Load health metrics for management
        async function loadHealthMetricsForManagement() {
            try {
                const { data: metrics, error } = await supabase
                    .from('health_metrics')
                    .select(`
                        *,
                        health_metric_categories (
                            category_id,
                            health_categories (
                                name
                            )
                        )
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allHealthMetrics = metrics || [];
                displayHealthMetricsForManagement(allHealthMetrics);
            } catch (error) {
                console.error('Error loading health metrics:', error);
                alert('Error loading health metrics: ' + error.message);
            }
        }

        // Display health metrics in management view
        function displayHealthMetricsForManagement(metrics) {
            const metricsList = document.getElementById('metricsList');
            
            if (!metrics || metrics.length === 0) {
                metricsList.innerHTML = '<p class="no-data">No health metrics found.</p>';
                return;
            }

            metricsList.innerHTML = metrics.map(metric => {
                // Extract category names
                const categoryNames = [];
                if (metric.health_metric_categories && metric.health_metric_categories.length > 0) {
                    metric.health_metric_categories.forEach(rel => {
                        if (rel.health_categories && rel.health_categories.name) {
                            categoryNames.push(rel.health_categories.name);
                        }
                    });
                }

                return `
                <div class="manager-item">
                    <div class="item-content">
                        <h4>${escapeHtml(metric.name || 'Untitled Metric')}</h4>
                        <p class="item-meta">
                            <span class="identifier">${escapeHtml(metric.identifier || 'No identifier')}</span>
                            <span class="unit">${escapeHtml(metric.unit || 'No unit')}</span>
                            <span class="kind">${escapeHtml(metric.kind || 'quantity')}</span>
                            ${categoryNames.length > 0 ? categoryNames.map(name => `<span class="category">${escapeHtml(name)}</span>`).join('') : ''}
                        </p>
                        <p class="item-description">${escapeHtml(metric.identifier || 'HealthKit metric')}</p>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-small btn-secondary" onclick="editMetric('${metric.id}')">Edit</button>
                        <button class="btn btn-small btn-danger" onclick="deleteMetric('${metric.id}')">Delete</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        // Add new metric
        function addNewMetric() {
            document.getElementById('metricModalTitle').textContent = 'Add New Health Metric';
            document.getElementById('metricForm').reset();
            document.getElementById('metricId').value = '';
            populateHealthCategoriesDropdown();
            document.getElementById('metricModal').style.display = 'block';
        }

        // Edit metric
        async function editMetric(metricId) {
            try {
                const { data: metric, error } = await supabase
                    .from('health_metrics')
                    .select('*')
                    .eq('id', metricId)
                    .single();

                if (error) throw error;

                // Get current categories for this metric
                const { data: currentCategories, error: categoriesError } = await supabase
                    .from('health_metric_categories')
                    .select('category_id')
                    .eq('metric_id', metricId);

                if (categoriesError) throw categoriesError;

                // Populate form
                document.getElementById('metricModalTitle').textContent = 'Edit Health Metric';
                document.getElementById('metricId').value = metric.id;
                document.getElementById('metricName').value = metric.name || '';
                document.getElementById('metricIdentifier').value = metric.identifier || '';
                document.getElementById('metricUnit').value = metric.unit || '';
                document.getElementById('metricKind').value = metric.kind || 'quantity';
                document.getElementById('metricUnitInternal').value = metric.unit_internal || '';
                document.getElementById('metricUnitDisplayStrategy').value = metric.unit_display_strategy || 'by_locale';

                // Handle preferred stats (array)
                const preferredStatsSelect = document.getElementById('metricPreferredStats');
                if (metric.preferred_stats && metric.preferred_stats.length > 0) {
                    Array.from(preferredStatsSelect.options).forEach(option => {
                        option.selected = metric.preferred_stats.includes(option.value);
                    });
                }

                // Populate categories dropdown and select current ones
                await populateHealthCategoriesDropdown();
                const categorySelect = document.getElementById('metricCategories');
                if (currentCategories && currentCategories.length > 0) {
                    const currentCategoryIds = currentCategories.map(cat => cat.category_id);
                    Array.from(categorySelect.options).forEach(option => {
                        option.selected = currentCategoryIds.includes(option.value);
                    });
                }

                document.getElementById('metricModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading metric:', error);
                alert('Error loading metric: ' + error.message);
            }
        }

        // Delete metric
        async function deleteMetric(metricId) {
            if (!confirm('Are you sure you want to delete this health metric? This action cannot be undone.')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('health_metrics')
                    .delete()
                    .eq('id', metricId);

                if (error) throw error;

                alert('Health metric deleted successfully!');
                loadHealthMetricsForManagement();
            } catch (error) {
                console.error('Error deleting metric:', error);
                alert('Error deleting metric: ' + error.message);
            }
        }

        // Populate health categories dropdown
        async function populateHealthCategoriesDropdown() {
            try {
                const { data: categories, error } = await supabase
                    .from('health_categories')
                    .select('id, name')
                    .order('name');

                if (error) throw error;

                const select = document.getElementById('metricCategories');
                select.innerHTML = '';

                if (categories && categories.length > 0) {
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading health categories:', error);
            }
        }

        // Close metric modal
        function closeMetricModal() {
            document.getElementById('metricModal').style.display = 'none';
        }

        // Handle metric form submission
        document.getElementById('metricForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const metricData = {
                name: formData.get('name'),
                identifier: formData.get('identifier'),
                unit: formData.get('unit'),
                kind: formData.get('kind'),
                unit_internal: formData.get('unit_internal'),
                unit_display_strategy: formData.get('unit_display_strategy'),
                preferred_stats: Array.from(document.getElementById('metricPreferredStats').selectedOptions).map(option => option.value)
            };

            const selectedCategories = Array.from(document.getElementById('metricCategories').selectedOptions).map(option => option.value);
            const metricId = formData.get('id');

            try {
                if (metricId) {
                    // Update existing metric
                    const { error } = await supabase
                        .from('health_metrics')
                        .update(metricData)
                        .eq('id', metricId);

                    if (error) throw error;

                    // Update category relationships
                    await updateMetricCategories(metricId, selectedCategories);

                    alert('Health metric updated successfully!');
                } else {
                    // Create new metric
                    const { data: newMetric, error } = await supabase
                        .from('health_metrics')
                        .insert(metricData)
                        .select()
                        .single();

                    if (error) throw error;

                    // Add category relationships
                    if (selectedCategories.length > 0) {
                        await updateMetricCategories(newMetric.id, selectedCategories);
                    }

                    alert('Health metric created successfully!');
                }

                closeMetricModal();
                loadHealthMetricsForManagement();
            } catch (error) {
                console.error('Error saving metric:', error);
                alert('Error saving metric: ' + error.message);
            }
        });

        // Update metric category relationships
        async function updateMetricCategories(metricId, selectedCategoryIds) {
            try {
                // First, delete all existing category relationships for this metric
                const { error: deleteError } = await supabase
                    .from('health_metric_categories')
                    .delete()
                    .eq('metric_id', metricId);

                if (deleteError) throw deleteError;

                // Then, insert new category relationships
                if (selectedCategoryIds.length > 0) {
                    const categoryRelations = selectedCategoryIds.map(categoryId => ({
                        metric_id: metricId,
                        category_id: categoryId
                    }));

                    const { error: insertError } = await supabase
                        .from('health_metric_categories')
                        .insert(categoryRelations);

                    if (insertError) throw insertError;
                }
            } catch (error) {
                console.error('Error updating metric categories:', error);
                throw error;
            }
        }

        // ===== UTILITY FUNCTIONS =====

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Search functionality for protocols
        document.getElementById('protocolSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredProtocols = allProtocols.filter(protocol => 
                protocol.name.toLowerCase().includes(searchTerm) ||
                protocol.category.toLowerCase().includes(searchTerm) ||
                (protocol.description && protocol.description.toLowerCase().includes(searchTerm)) ||
                (protocol.citations && protocol.citations.some(citation => {
                    if (typeof citation === 'string') {
                        return citation.toLowerCase().includes(searchTerm);
                    } else if (citation && citation.title) {
                        return citation.title.toLowerCase().includes(searchTerm);
                    }
                    return false;
                }))
            );
            displayProtocolsForManagement(filteredProtocols);
        });

        // Search functionality for metrics
        document.getElementById('metricSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredMetrics = allHealthMetrics.filter(metric => {
                // Search in basic fields
                if (metric.name.toLowerCase().includes(searchTerm) ||
                    metric.identifier.toLowerCase().includes(searchTerm) ||
                    (metric.unit && metric.unit.toLowerCase().includes(searchTerm))) {
                    return true;
                }
                
                // Search in categories
                if (metric.health_metric_categories && metric.health_metric_categories.length > 0) {
                    const hasMatchingCategory = metric.health_metric_categories.some(rel => 
                        rel.health_categories && rel.health_categories.name.toLowerCase().includes(searchTerm)
                    );
                    if (hasMatchingCategory) {
                        return true;
                    }
                }
                
                return false;
            });
            displayHealthMetricsForManagement(filteredMetrics);
        });

        // ===== CITATION MANAGEMENT =====

        // Add a new citation field
        function addCitationField(citationData = {}) {
            const container = document.getElementById('citationsContainer');
            const citationId = 'citation_' + Date.now();
            
            const citationDiv = document.createElement('div');
            citationDiv.className = 'citation-item';
            citationDiv.style.cssText = 'border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background-color: #f8f9fa;';
            
            citationDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0; color: #495057; font-size: 0.9rem;">Citation ${container.children.length + 1}</h4>
                    <button type="button" class="btn btn-danger btn-small" onclick="removeCitationField(this)" style="padding: 4px 8px; font-size: 0.8rem;">
                        Remove
                    </button>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 5px; font-size: 0.9rem;">Title *</label>
                        <input 
                            type="text" 
                            id="${citationId}_title" 
                            class="citation-title-input" 
                            placeholder="Enter citation title (e.g., Study on Sleep Optimization)" 
                            value="${citationData.title || ''}"
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"
                        />
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 5px; font-size: 0.9rem;">URL *</label>
                        <input 
                            type="url" 
                            id="${citationId}_url" 
                            class="citation-url-input" 
                            placeholder="https://example.com/study-link" 
                            value="${citationData.url || ''}"
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"
                        />
                    </div>
                </div>
            `;
            
            container.appendChild(citationDiv);
        }

        // Remove a citation field
        function removeCitationField(button) {
            button.parentElement.remove();
        }

        // Clear all citations
        function clearAllCitations() {
            const container = document.getElementById('citationsContainer');
            container.innerHTML = '';
        }

        // Get all citations as an array of objects
        function getAllCitations() {
            const container = document.getElementById('citationsContainer');
            const citationItems = container.querySelectorAll('.citation-item');
            const citations = [];
            
            console.log('Found citation items:', citationItems.length);
            
            citationItems.forEach((item, index) => {
                const titleInput = item.querySelector('.citation-title-input');
                const urlInput = item.querySelector('.citation-url-input');
                
                console.log(`Citation ${index}:`, {
                    titleInput: titleInput,
                    urlInput: urlInput,
                    titleValue: titleInput ? titleInput.value : 'no title input',
                    urlValue: urlInput ? urlInput.value : 'no url input'
                });
                
                if (titleInput && urlInput) {
                    const title = titleInput.value.trim();
                    const url = urlInput.value.trim();
                    
                    // Only add if both title and URL are provided
                    if (title && url) {
                        citations.push({
                            title: title,
                            url: url
                        });
                    }
                }
            });
            
            console.log('Final citations array:', citations);
            return citations;
        }

        // Load citations into the form
        function loadCitations(citations) {
            clearAllCitations();
            
            if (citations && citations.length > 0) {
                citations.forEach(citation => {
                    // Handle both old string format and new object format
                    if (typeof citation === 'string') {
                        // Legacy format - create a basic object
                        addCitationField({
                            title: citation,
                            url: ''
                        });
                    } else if (citation && (citation.title || citation.name)) {
                        // New object format
                        addCitationField({
                            title: citation.title || citation.name,
                            url: citation.url || ''
                        });
                    }
                });
            } else {
                // Add one empty field by default
                addCitationField();
            }
        }
    </script>
</body>
</html>
